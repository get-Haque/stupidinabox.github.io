LollyMatch.Game=function(){this.gamePaused=!1,this.hintActive=!1,this.i=0,this.j=0,this.counter=0,this.gameOver=!1,this.move=0,this.highScore=0,this.score=0,this.scoreBuffer=0,this.lollyType=6,this.charCount=6,this.fieldSize={rows:6,cols:6},LollyMatch.scaleFactor<4?this.fallSpeed=200:LollyMatch.scaleFactor<8?this.fallSpeed=400:this.fallSpeed=600,this.currentColor="ffffff",this.tilesArray=[],this.arrowsArray=[],this.visitedTiles=[],this.removedTiles=[],this.clearTilePos=[],this.charArray=[],this.numberArray=[],this.colorArray=["#FBCC00","#0094EF","#A5F700","#7F10EE","#F20042","#F45400"],this.angleArray=[0,45,90,135,180,220,260,300]},LollyMatch.Game.prototype={create:function(){function t(t){if(S.gamePaused&&S["switch"].play(),S.gamePaused){var i=b[1].x,e=b[1].x+b[1].width,s=b[1].y,h=b[1].y+b[1].height,a=b[2],o=b[3],l=b[4],r=b[5];t.x>i&&t.x<e&&t.y>s&&t.y<h&&(t.x>a.x-a.width/2&&t.x<a.x+a.width/2&&t.y>a.y-a.height/2&&t.y<a.y+a.height/2&&(S.gamePaused=!1,L.frame=3,L.alpha=.6,b[0].destroy(),T.inputEnabled=!0),t.x>o.x-o.width/2&&t.x<o.x+o.width/2&&t.y>o.y-o.height/2&&t.y<o.y+o.height/2&&(S.gamePaused=!1,S.reloadState()),t.x>l.x-l.width/2&&t.x<l.x+l.width/2&&t.y>l.y-l.height/2&&t.y<l.y+l.height/2&&(S.sound.mute,S.soundToggle(l)),t.x>r.x-r.width/2&&t.x<r.x+r.width/2&&t.y>r.y-r.height/2&&t.y<r.y+r.height/2&&(S.gamePaused=!1,S.menuSate()))}}for(this.game.canvas.oncontextmenu=function(t){t.preventDefault()},console.log("Game Started"),this.getHighScore(),this.score=0,LollyMatch.isSoundMute=JSON.parse(localStorage.getItem("LollyMatchSound")),this.sound.mute=LollyMatch.isSoundMute,this.ml=new MultiLang,this.ml.phrases=this.cache.getJSON("mylangs"),this.ml.setLanguage(LollyMatch.langSelect),this.sound.mute=LollyMatch.isSoundMute,this["switch"]=this.add.audio("switch"),this.pick1=this.add.audio("pick1"),this.pick2=this.add.audio("pick2"),this.pick3=this.add.audio("pick3"),this.drop1=this.add.audio("drop1"),this.drop2=this.add.audio("drop2"),this["switch"].volume=.4,this.tileSize=.16*LollyMatch.safeZone.width,this.lollyW=.15*LollyMatch.safeZone.width,this.lollyH=this.lollyW,this.pickedW=this.lollyW+3,this.arrowW=.5*LollyMatch.safeZone.width,this.arrowH=this.arrowW,this.bubbleW=.17*LollyMatch.safeZone.width,this.bubbleH=.17*LollyMatch.safeZone.width,this.charW=.16*LollyMatch.safeZone.width,this.charH=.16*LollyMatch.safeZone.width,this.dropH=.3*this.lollyH,this.dropW=.2*this.lollyW;this.numberArray.length<this.charCount;){var i=this.rnd.between(0,this.lollyType-1);this.numberArray.indexOf(i)>-1||(this.numberArray[this.numberArray.length]=i)}for(var e=[.1,.16,.2,.24,.28],s=-60;s<this.game.width+100;s+=150)for(var h=0;h<this.game.height+100;h+=180){var a=this.rnd.between(0,4),o=Phaser.ArrayUtils.getRandomItem(this.angleArray),l=this.add.sprite(s,h,"backSymb",a),r=Phaser.ArrayUtils.getRandomItem(e);l.scale.setTo(LollyMatch.scaleFactor+r),l.angle=o,l.alpha=.6}for(var d=.65*LollyMatch.safeZone.width,n=0,c=0;c<this.game.width+2*d;c+=d/2.5){var y=this.numberArray[n],u=this.add.image(c,20,"brick",y);u.width=d,u.height=d,u.anchor.setTo(.3),u.angle=180,n<this.numberArray.length?n++:n=1}var g=LollyMatch.safeZone.width,p=LollyMatch.safeZone.height,f=LollyMatch.safeZone.x,w=0,x=this.add.graphics(f,w);x.beginFill(0),x.drawRect(0,0,g,p);for(var v=this.add.group(),m=LollyMatch.safeZone.x;m<LollyMatch.safeZone.x+LollyMatch.safeZone.width;m+=300)for(var M=0;M<this.world.height;M+=300)back=this.add.sprite(m,M,"background"),back.width=300,back.height=300,v.add(back);v.mask=x,this.sunSize=.2*LollyMatch.safeZone.height,this.sun=this.add.sprite(LollyMatch.safeZone.x+this.sunSize/4.5,this.sunSize/3,"sunM"),this.sun.height=this.sunSize,this.sun.scale.x=this.sun.scale.y,this.sun.anchor.setTo(.5),this.sunLight=this.add.sprite(LollyMatch.safeZone.x+this.sunSize/4.5,this.sunSize/3,"sunM",2),this.sunLight.width=this.sunSize,this.sunLight.height=this.sunLight.width,this.sunLight.anchor.setTo(.5),this.sunLight.OriginalSize=.3*LollyMatch.safeZone.height,this.sun.bringToTop(),this.sun.mask=x,this.sunLight.mask=x,this.pause=this.add.group(),this.failed=this.add.group(),this.win=this.add.group();var T=this.add.sprite(LollyMatch.safeZone.x+LollyMatch.safeZone.width,0,"uiBig",7);T.width=.26*LollyMatch.safeZone.width,T.height=T.width,T.anchor.setTo(.5),T.mask=x;var L=this.add.sprite(T.x-T.width/6,T.y+T.width/6.5,"uiSmall",3);L.width=.15*LollyMatch.safeZone.width,L.height=L.width,L.anchor.setTo(.5),L.alpha=.6;var b;T.inputEnabled=!0,T.events.onInputUp.add(function(){this.gamePaused=!0,L.frame=4,L.alpha=.3,b=this.createPauseMenu(),T.inputEnabled=!1},this);var S=this;this.input.onDown.add(t,self);for(var k=.6*LollyMatch.safeZone.width,A=this.add.group(),G=LollyMatch.safeZone.x-2*k;G<LollyMatch.safeZone.width+4*k;G+=k/2.5){var P=this.numberArray[n],Z=this.add.image(G,LollyMatch.safeZone.height,"brick",P);Z.width=d,Z.height=d,Z.anchor.setTo(.3),A.add(Z),n<this.numberArray.length?n++:n=1}A.mask=x;var z=3923390,B=this.add.graphics(0,0);B.lineStyle(1.5,z),B.moveTo(LollyMatch.safeZone.x,0),B.lineTo(LollyMatch.safeZone.x,this.game.height);var H=this.add.graphics(0,0);H.lineStyle(1.5,z),H.moveTo(LollyMatch.safeZone.x+LollyMatch.safeZone.width,0),H.lineTo(LollyMatch.safeZone.x+LollyMatch.safeZone.width,this.game.height),this.scoreText=this.add.text(this.world.centerX,40,this.ml.get("Score")+": "+this.score,LollyMatch.style),this.scoreText.anchor.set(.5),this.scoreTextTween=this.add.tween(this.scoreText.scale).to({x:1.2,y:1.2},200,Phaser.Easing.Linear.In).to({x:1,y:1},200,Phaser.Easing.Linear.In),this.createLevel(),this.createChar(),this.input.onDown.add(this.pickTile,this),this.clickText=this.add.text(this.world.centerX,this.world.height-20,this.ml.get("Click"),LollyMatch.style),this.clickText.anchor.setTo(.5),this.clickTextTween=this.add.tween(this.clickText.scale).to({x:1.1,y:1.1},200,Phaser.Easing.Linear.In).to({x:1,y:1},200,Phaser.Easing.Linear.In),0===LollyMatch.counter2?(LollyMatch.counter2++,localStorage.setItem("LollyMatchhint",JSON.stringify(LollyMatch.counter2)),this.createHint(T)):this.clickText.visible=!1},createHint:function(t){var i=this.add.graphics(LollyMatch.safeZone.x,LollyMatch.safeZone.y);i.beginFill(0),i.drawRect(0,0,LollyMatch.safeZone.width,LollyMatch.safeZone.height),i.alpha=.2,t.inputEnabled=!1;var e=this.createHintBack(this.charMaskX+.01*this.charMaskW,this.charMaskY+this.charMaskH/3),s=this.add.image(LollyMatch.safeZone.x+LollyMatch.safeZone.width/2,.18*LollyMatch.safeZone.height,"ui_back");s.width=.8*LollyMatch.safeZone.width,s.height=s.width/3,s.anchor.setTo(.5),s.visible=!1,this.clickText.visible=!0,this.clickText.bringToTop();var h=this.insertText(e,this.ml.get("healtHint")),a=this.insertText(e,this.ml.get("reviveHint")),o=this.insertText(e,this.ml.get("scoreHint")),l=this.insertText(e,this.ml.get("reloadHint")),r=this.insertText(e,this.ml.get("videoHint")),d=this.insertText(e,this.ml.get("closingHint"));a.visible=!1,o.visible=!1,l.visible=!1,r.visible=!1,d.visible=!1,this.hintActive=!0,this.input.onDown.add(function(){e.x=this.sun.x-.09*this.sun.width,e.y=this.sun.y+.04*this.sun.height,h.destroy(),a.visible=!0,this.rePositionText(a,e.x,e.y,e),this.input.onDown.add(function(){e.x=this.scoreText.x-1.1*this.scoreText.width,e.y=this.scoreText.y+.04*this.scoreText.height,a.destroy(),o.visible=!0,this.rePositionText(o,e.x,e.y,e),this.input.onDown.add(function(){var t;t="ko"==LollyMatch.langSelect?this.reloadText.x+1*this.reloadText.width:this.reloadText.x+1.25*this.reloadText.width,e.x=t,e.y=this.reloadText.y+.04*this.reloadText.height,o.destroy(),l.visible=!0,this.rePositionText2(l,e.x,e.y,e),e.angle=180,this.input.onDown.add(function(){e.destroy();var t=this.add.video("hintV"),h=.002*LollyMatch.safeZone.width,a=h,o=t.addToWorld(this.world.centerX,this.world.centerY,.5,.45,h,a);t.play(!0),l.destroy(),r.visible=!0,s.visible=!0,this.rePositionText3(r,s),this.input.onDown.add(function(){r.destroy(),d.visible=!0,this.rePositionText3(d,s),this.input.onDown.add(function(){this.clickText.visible=!1,d.destroy(),s.destroy(),o.destroy(),i.destroy(),this.hintActive=!1,this.reloadState()},this)},this)},this)},this)},this)},this)},insertText:function(t,i){var e=this.add.text(t.x+.1*t.width,t.y+.5*t.height,i,LollyMatch.style2.c);return e.anchor.setTo(0,0),e},rePositionText:function(t,i,e,s){t.x=i+.1*s.width,t.y=e+.5*s.height},rePositionText2:function(t,i,e,s){t.x=i-.9*s.width,t.y=e-.8*s.height},rePositionText3:function(t,i){t.x=i.x+.01*i.width,t.y=i.y+.01*i.height,t.anchor.setTo(.5)},createHintBack:function(t,i){var e=this.add.image(t,i,"hint_back");return e.width=.8*LollyMatch.safeZone.width,e.height=e.width/2,e},createPauseMenu:function(){var t=this.add.group(),i=this.createBack(),e=this.add.sprite(i.x+i.width/2,i.y+.2*i.height,"uiBig",0);e.anchor.setTo(.5),e.width=.3*i.width,e.height=e.width;var s=this.add.sprite(e.x-e.width,e.y+e.height,"uiBig",1);s.width=.25*i.width,s.height=s.width,s.anchor.setTo(.5);var h;h=LollyMatch.isSoundMute?6:5;var a=this.add.sprite(e.x,e.y+e.height,"uiBig",h);a.width=.25*i.width,a.height=a.width,a.anchor.setTo(.5),a.value=h;var o=this.add.sprite(e.x+e.width,e.y+e.height,"uiBig",2);o.width=.25*i.width,o.height=o.width,o.anchor.setTo(.5);var l=this.add.text(e.x,e.y+1.9*e.height,this.ml.get("High Score"),LollyMatch.style2.a);l.anchor.set(.5);var r=this.add.text(e.x,e.y+2.3*e.height,this.highScore,LollyMatch.style2.a);return r.anchor.set(.5),t.add(i),t.add(e),t.add(s),t.add(a),t.add(o),t.add(l),t.add(r),objArray=[t,i,e,s,a,o],objArray},createBack:function(){var t=this.add.group(),i=.15*LollyMatch.safeZone.height,e=.25*LollyMatch.safeZone.height,s=this.add.sprite(0,0,"ui_back"),h=this.add.sprite(0,i,"ui_back"),a=this.add.sprite(0,e,"ui_back");return s.width=.82*LollyMatch.safeZone.width,s.height=s.width/2,h.width=s.width,h.height=s.height,a.width=s.width,a.height=s.height,t.add(s),t.add(h),t.add(a),t.x=this.world.centerX-t.width/2,t.y=this.world.centerY-t.height/2.2,t},soundToggle:function(t){this.sound.mute?(this.sound.mute=!1,t.frame=5,LollyMatch.isSoundMute=!1,localStorage.setItem("LollyMatchSound",JSON.stringify(LollyMatch.isSoundMute))):(this.sound.mute=!0,t.frame=6,LollyMatch.isSoundMute=!0,localStorage.setItem("LollyMatchSound",JSON.stringify(LollyMatch.isSoundMute)))},reload:function(){if(!this.gameOver&&!this.gamePaused){this.reloadTextTween.start(),LollyMatch.otherSound[0].play();for(var t=0;t<this.fieldSize.rows;t++)for(var i=0;i<this.fieldSize.cols;i++){var e=this.rnd.between(0,this.lollyType-1);this.tilesArray[t][i].frame=e,this.tilesArray[t][i].value=e}}},createChar:function(){this.bubbleGroup=this.add.group(),this.bodyGroup=this.add.group(),this.faceGroup=this.add.group(),this.maskGroup=this.add.group(),this.charGroup=this.add.group(),this.charGroup.add(this.bubbleGroup),this.charGroup.add(this.bodyGroup),this.charGroup.add(this.faceGroup),this.charGroup.add(this.maskGroup),this.charGroup.x=(this.game.width-this.tileSize*this.fieldSize.cols)/2+this.tileSize,this.charGroup.y=this.tileGroup.y/2.5;for(var t=0;t<1;t++){this.charArray[t]=[];for(var i=0;i<this.charCount;i++)this.addchar(t,i)}this.game.world.bringToTop(this.bubbleGroup),this.charMaskW=this.bubbleGroup.width/1.9,this.charMaskH=1.8*this.bubbleGroup.height,this.charMaskX=this.tileGroup.x+this.tileSize,this.charMaskY=this.charGroup.y-.2*this.charMaskH;var e=this.add.graphics(this.charMaskX,this.charMaskY);e.beginFill(0),e.drawRect(0,0,this.charMaskW,this.charMaskH),e.alpha=.1,this.charGroup.mask=e},updatecharPosbytime:function(){LollyMatch.scaleFactor>.8?speed=1.5:LollyMatch.scaleFactor>.4?speed=1:speed=.5;for(var t=1e-4*this.world.width,i=t+this.charGroup.width-5,e=0;e<this.charCount;e++){var s=this.charArray[0][e],h=this.charArray[0][e].charBody,a=this.charArray[0][e].charface,o=this.charArray[0][e].bodyMask;s.x<t&&h.x<t&&a.x<t&&o.x<t?(s.x=i,h.x=i,a.x=i,o.x=i+h.width/2):(s.x-=speed,h.x-=speed,a.x-=speed,o.x-=speed),s.x>t-s.width&&h.x>t-s.width&&a.x>t-s.width&&o.x>t-s.width&&s.x<t+s.width/1.1+this.charMaskW&&h.x<t+s.width/1.1+this.charMaskW&&a.x<t+s.width/1.1+this.charMaskW&&o.x<t+s.width/1.1+this.charMaskW?s.isDead?s.isInRange=!0:s.isActive=!0:(s.isActive=!1,s.isInRange=!1)}},updatecharHealthbytime:function(){for(var t=0;t<this.charCount;t++){this.charArray[0][t];if(this.charArray[0][t].bodyMask.height>0&&!this.charArray[0][t].isDead){this.charArray[0][t].bodyMask.height-=.025;this.charArray[0][t].charface}else this.charArray[0][t].isDead=!0,this.charArray[0][t].charface.frame=this.charArray[0][t].value+18}},addchar:function(t,i){var e=this.numberArray[this.j];this.j++;var s=i*this.tileSize+this.tileSize/2,h=t*this.tileSize+this.tileSize/2,a=this.add.sprite(1.4*s,h,"bubble",e);a.charBody=this.add.sprite(1.4*s,h,"body",e),a.charface=this.add.sprite(1.4*s,h,"face",e),a.bodyMask=this.add.graphics(a.charBody.x+this.charW/2,a.charBody.y+this.charH/2),a.bodyMask.beginFill(0),a.bodyMask.drawRect(0,0,this.charW,this.charH),a.bodyMask.angle=180,a.anchor.setTo(.5),a.width=this.bubbleW,a.height=this.bubbleH,a.charBody.anchor.setTo(.5),a.charBody.width=this.charW,a.charBody.height=this.charH,a.charface.anchor.setTo(.5),a.charface.width=this.charW,a.charface.height=this.charH,a.value=e,a.isActive=!1,a.isDead=!1,a.isInRange=!1,a.charBody.mask=a.bodyMask,this.charArray[t][i]=a,this.bubbleGroup.add(a),this.bodyGroup.add(a.charBody),this.maskGroup.add(a.bodyMask),this.faceGroup.add(a.charface)},createLevel:function(){this.boardGroup=this.add.group(),this.tileGroup=this.add.group(),this.arrowsGroup=this.add.group(),this.boardGroup.x=(this.game.width-this.tileSize*this.fieldSize.cols)/2,this.boardGroup.y=(this.game.height-this.tileSize*this.fieldSize.rows)/1.8,this.tileGroup.x=this.boardGroup.x,this.tileGroup.y=this.boardGroup.y,this.arrowsGroup.x=this.tileGroup.x,this.arrowsGroup.y=this.tileGroup.y;var t=this.add.graphics(this.tileGroup.x,this.tileGroup.y-this.tileSize);t.beginFill(0),t.drawRect(0,0,this.tileSize*this.fieldSize.cols,this.tileSize*this.fieldSize.rows+this.tileSize),this.tileGroup.mask=t;for(var i=0;i<this.fieldSize.rows;i++){this.tilesArray[i]=[];for(var e=0;e<this.fieldSize.cols;e++)this.drawBoard(i,e),this.addTile(i,e)}this.game.world.bringToTop(this.tileGroup),this.reloadText=this.add.text(this.world.centerX,this.boardGroup.y+this.boardGroup.width+40,this.ml.get("Reload"),LollyMatch.style),this.reloadText.anchor.setTo(.5),this.reloadText.inputEnabled=!0,this.reloadText.events.onInputDown.add(this.reload,this),this.reloadTextTween=this.add.tween(this.reloadText.scale).to({x:1.1,y:1.1},200,Phaser.Easing.Linear.In).to({x:1,y:1},200,Phaser.Easing.Linear.In)},drawBoard:function(t,i){var e=this.add.bitmapData(this.tileSize+4,this.tileSize+4);e.ctx.fillStyle=0,e.ctx.fillRect(0,0,this.tileSize+2,this.tileSize+2);var s=i*this.tileSize+this.tileSize/2,h=t*this.tileSize+this.tileSize/2,a=this.add.sprite(s,h,e);a.anchor.setTo(.5),a.alpha=.1,this.boardGroup.add(a)},addTile:function(t,i){this.lollyGroup=this.add.group();var e=this.rnd.between(0,this.lollyType-1),s=i*this.tileSize+this.tileSize/2,h=t*this.tileSize+this.tileSize/2,a=this.add.sprite(s,h,"lolly",e);a.value=e,a.anchor.set(.5),a.width=this.lollyW,a.height=this.lollyH,this.lollyGroup.add(a),a.picked=!1,a.coordinate=new Phaser.Point(i,t),this.tilesArray[t][i]=a,this.tileGroup.add(a)},pickTile:function(t){if(this.visitedTiles.length=0,this.tileGroup.getBounds().contains(t.position.x,t.position.y)&&!this.gamePaused&&!this.gameOver){var i=Math.floor((t.position.x-this.tileGroup.x)/this.tileSize),e=Math.floor((t.position.y-this.tileGroup.y)/this.tileSize);this.tilesArray[e][i].frame=this.tilesArray[e][i].value+this.lollyType,this.tilesArray[e][i].width=this.pickedW,this.tilesArray[e][i].picked=!0,this.pickedLolly=this.tilesArray[e][i].value,this.input.onUp.add(this.releaseTile,this),this.input.addMoveCallback(this.moveTile,this),this.visitedTiles.push(this.tilesArray[e][i].coordinate),this.clearTime=this.time.now,this.move++,this.sound&&this.pick1.play()}},moveTile:function(t){if(this.tileGroup.getBounds().contains(t.position.x,t.position.y)){var i=Math.floor((t.position.x-this.tileGroup.x)/this.tileSize),e=Math.floor((t.position.y-this.tileGroup.y)/this.tileSize);new Phaser.Point(t.position.x-this.tileGroup.x,t.position.y-this.tileGroup.y).distance(this.tilesArray[e][i])<.4*this.tileSize&&this.tilesArray[e][i].value==this.pickedLolly&&(!this.tilesArray[e][i].picked&&this.checkAdjacent(new Phaser.Point(i,e),this.visitedTiles[this.visitedTiles.length-1])?(this.tilesArray[e][i].picked=!0,this.tilesArray[e][i].frame=this.tilesArray[e][i].value+this.lollyType,this.tilesArray[e][i].width=this.pickedW,this.visitedTiles.push(this.tilesArray[e][i].coordinate),this.addArrow(),this.sound&&this.pick2.play()):this.visitedTiles.length>1&&e==this.visitedTiles[this.visitedTiles.length-2].y&&i==this.visitedTiles[this.visitedTiles.length-2].x&&(this.tilesArray[this.visitedTiles[this.visitedTiles.length-1].y][this.visitedTiles[this.visitedTiles.length-1].x].picked=!1,this.tilesArray[this.visitedTiles[this.visitedTiles.length-1].y][this.visitedTiles[this.visitedTiles.length-1].x].frame=this.tilesArray[e][i].value,this.tilesArray[this.visitedTiles[this.visitedTiles.length-1].y][this.visitedTiles[this.visitedTiles.length-1].x].width=this.lollyW,this.tilesArray[this.visitedTiles[this.visitedTiles.length-1].y][this.visitedTiles[this.visitedTiles.length-1].x].height=this.lollyH,this.visitedTiles.pop(),this.arrowsArray[this.arrowsArray.length-1].destroy(),this.arrowsArray.pop(),this.sound&&this.pick3.play()))}},releaseTile:function(){this.input.onUp.remove(this.releaseTile,this),this.input.deleteMoveCallback(this.moveTile,this),this.clearPath()},releaseTile2:function(){this.tilesFallDown(),this.placeNewTiles(),this.sound&&this.pick3.play()},checkAdjacent:function(t,i){return Math.abs(t.x-i.x)<=1&&Math.abs(t.y-i.y)<=1},addArrow:function(){var t=this.visitedTiles[this.visitedTiles.length-2],i=this.add.sprite(this.tilesArray[t.y][t.x].x,this.tilesArray[t.y][t.x].y,"arrows",this.pickedLolly);i.width=this.arrowW,i.height=this.arrowH,this.arrowsGroup.add(i),i.anchor.set(.5);var e=new Phaser.Point(this.visitedTiles[this.visitedTiles.length-1].x,this.visitedTiles[this.visitedTiles.length-1].y);e.subtract(this.visitedTiles[this.visitedTiles.length-2].x,this.visitedTiles[this.visitedTiles.length-2].y),0===e.x?i.angle=-90*e.y:(i.angle=90*(e.x+1),0!==e.y&&(i.frame=this.pickedLolly+this.lollyType,e.y+e.x===0&&(i.angle-=90))),this.arrowsArray.push(i)},clearPath:function(){this.arrowsGroup.removeAll(!0),this.clearTilePos.length=0;for(var t=0;t<this.visitedTiles.length;t++)if(this.visitedTiles.length>2){this.input.enabled=!1,this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].frame=this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].value+2*this.lollyType,this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].width=this.lollyW,this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].height=this.lollyH;var i=this.tileGroup.x+this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].x,e=this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].y+3.4*this.tileSize,s=this.add.sprite(i,e,"drop",this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].value);s.width=this.dropW,s.height=this.dropH,s.charAliveCount=0,s.sunHit=!1,s.count=this.visitedTiles.length;for(var h,a=0;a<this.charCount;a++)h=this.game.width<650?this.tileGroup.x+this.charArray[0][a].charBody.x-.2*this.bubbleW:this.tileGroup.x+this.charArray[0][a].charBody.x-this.bubbleW/1.4,s.frame===this.charArray[0][a].frame&&(this.charArray[0][a].isActive&&!this.charArray[0][a].isDead?this.charArray[0][a].x<this.charMaskX?(s.tweenX=h+this.bubbleW/2+this.bubbleW,s.tweenY=this.charMaskY+this.charW,s["char"]=this.charArray[0][a],s.fun=this.dropUpdate):(s.tweenX=h+this.bubbleW,s.tweenY=this.charMaskY+this.charW,s["char"]=this.charArray[0][a]):(s.tweenX=this.sun.x,s.tweenY=this.sun.y,s.sunHit=!0)),this.charArray[0][a].isDead||s.charAliveCount++;var o=this.game.add.tween(s).to({x:s.tweenX,y:s.tweenY},2*this.fallSpeed,Phaser.Easing.Exponential.None,!0);o.onComplete.add(this.dropUpdate,this),this.clearTilePos.push(this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].coordinate),this.time.events.add(.1*Phaser.Timer.SECOND,this.tileDisapear,this),this.removedTiles.length=0}else this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].frame=this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].value,this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].width=this.lollyW,this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].height=this.lollyH,this.tilesArray[this.visitedTiles[t].y][this.visitedTiles[t].x].picked=!1},dropUpdate:function(t){var i,e=t,s=2;if(i=e.charAliveCount>this.charCount?this.rnd.integerInRange((this.charCount-e.charAliveCount)/2,(this.charCount-e.charAliveCount)/2):e.charAliveCount/2,e.sunHit||this.gameOver)this.sunUpdate(e);else if(!e["char"].isDead&&e["char"].bodyMask.height<=this.charH){e["char"].bodyMask.height+=s,e["char"].charface.frame=e["char"].value+6,e.destroy(),this.drop1.play();var h=(e.count+e.charAliveCount)*i,a=h;this.scoreBufferAnimation(e.x,e.y,"+"+a,e["char"].value,e.charAliveCount,h,e.count),this.time.events.add(.3*Phaser.Timer.SECOND,this.charframeUpdate,this,e["char"])}else e.destroy(),this.drop1.play(),pointsExtra=(e.count+e.charAliveCount)*i,me=pointsExtra,this.scoreBufferAnimation(e.x,e.y,"+"+me,e["char"].value,e.charAliveCount,pointsExtra,e.count),this.time.events.add(.3*Phaser.Timer.SECOND,this.charframeUpdate,this,e["char"])},charframeUpdate:function(t){t.charface.frame=t.value},sunUpdate:function(t){var i=4;this.sunLight.width+=i,this.sunLight.height+=i,this.sun.frame=1,t.destroy(),this.drop2.play(),this.time.events.add(.3*Phaser.Timer.SECOND,this.updateSunFrame,this)},updateSunFrame:function(){this.sun.frame=0},scoreBufferAnimation:function(t,i,e,s,h,a,o){var l=a/o,r=this.add.text(t,i,e,LollyMatch.style3);r.anchor.setTo(.5),r.addColor(this.colorArray[s],0),this.currentColor=this.colorArray[s],this.game.add.tween(r).to({x:this.scoreText.x,y:this.scoreText.y},2*this.fallSpeed,Phaser.Easing.Exponential.None,!0).onComplete.add(function(){r.destroy(),this.scoreTextTween.start(),this.scoreBuffer+=l},this)},incrementScore:function(){this.score+=1,this.scoreText.setText(this.ml.get("Score")+": "+this.score),this.scoreTextTween.start()},destroyDrop:function(t){t.destroy()},tileDisapear:function(){for(var t=0;t<this.clearTilePos.length;t++)this.i++,this.tilesArray[this.clearTilePos[t].y][this.clearTilePos[t].x].visible=!1;this.tileArrayClear()},tileArrayClear:function(){this.removedTiles.length=0;var t=this.visitedTiles.length*this.visitedTiles.length;if(this.i>=t)for(var i=0;i<this.visitedTiles.length;i++)this.removedTiles.push(this.tilesArray[this.clearTilePos[i].y][this.clearTilePos[i].x]),this.tilesArray[this.visitedTiles[i].y][this.visitedTiles[i].x]=null;this.releaseTile2()},tilesFallDown:function(){this.input.enabled=!0;for(var t=this.fieldSize.cols-1;t>=0;t--)for(var i=0;i<this.fieldSize.rows;i++)if(null!==this.tilesArray[t][i]){var e=this.holesBelow(t,i);if(e>0){var s=new Phaser.Point(this.tilesArray[t][i].coordinate.x,this.tilesArray[t][i].coordinate.y),h=new Phaser.Point(i,t+e),a=this.add.tween(this.tilesArray[t][i]).to({y:this.tilesArray[t][i].y+e*this.tileSize},this.fallSpeed,Phaser.Easing.Linear.None,!0);a.onComplete.add(this.nextPick,this),this.tilesArray[h.y][h.x]=this.tilesArray[t][i],this.tilesArray[s.y][s.x]=null,this.tilesArray[h.y][h.x].coordinate=new Phaser.Point(h.x,h.y),this.i=0,this.sound}}},placeNewTiles:function(){this.input.enabled=!0;for(var t=0;t<this.fieldSize.cols;t++){var i=this.holesInCol(t);if(i>0)for(var e=1;e<=i;e++){var s=t*this.tileSize+this.tileSize/2,h=-e*this.tileSize+this.tileSize/2,a=this.removedTiles.pop();a.position=new Phaser.Point(s,h),a.visible=!0;var o=this.rnd.between(0,this.lollyType-1);a.value=o,a.frame=o,a.width=this.lollyW,a.height=this.lollyH,a.picked=!1;var l=this.add.tween(a).to({y:a.y+i*this.tileSize},this.fallSpeed,Phaser.Easing.Linear.None,!0);l.onComplete.add(this.nextPick,this),a.coordinate=new Phaser.Point(t,i-e),this.tilesArray[i-e][t]=a,this.i=0}}},nextPick:function(){this.input.onDown.has(this.pickTile,this)||(this.input.onDown.add(this.pickTile,this),console.log("added"))},holesBelow:function(t,i){for(var e=0,s=t+1;s<this.fieldSize.rows;s++)null===this.tilesArray[s][i]&&e++;return e},holesInCol:function(t){for(var i=0,e=0;e<this.fieldSize.rows;e++)null===this.tilesArray[e][t]&&i++;return i},revive:function(t){this.gameOver||(t["char"].isDead=!1,LollyMatch.otherSound[1].play(),t["char"].charface.frame=t["char"].value,t["char"].bodyMask.height=.15*this.charMaskH),t.destroy()},update:function(){var t=this.charCount,i=[],e=[];if(this.clickText.visible&&this.clickTextTween.start(),!this.gamePaused){this.updatecharPosbytime(),this.updatecharHealthbytime();for(var s=0;s<this.charCount;s++)this.charArray[0][s].isDead&&(t--,i.push(this.charArray[0][s]))}if(i.length>0)for(var h=0;h<i.length;h++)i[h].isInRange&&e.push(i[h]);if(this.sunLight.width>this.sunLight.OriginalSize&&(this.sunLight.width=this.sunSize,this.sunLight.height=this.sunSize,e.length>0)){var a=Phaser.ArrayUtils.getRandomItem(e),o=this.add.sprite(this.sun.x,this.sun.y,"drop",a.value);o.width=this.dropW,o.height=this.dropH,o["char"]=a;this.game.add.tween(o).to({x:LollyMatch.safeZone.x+a.x+this.charW,y:a.y+this.charH},2*this.fallSpeed,Phaser.Easing.Exponential.None,!0).onComplete.add(this.revive,this)}i.length=0,e.length=0,this.scoreBuffer>0&&(this.incrementScore(),this.scoreBuffer--),0!==t||0!==this.counter||this.hintActive||(this.gameOver=!0,this.getHighScore(),this.createOverScreen(),console.log("over"),this.counter++)},getHighScore:function(){null===localStorage.getItem("LollyMatchHighScore")?localStorage.setItem("LollyMatchHighScore",this.score):(this.highScore=parseInt(localStorage.getItem("LollyMatchHighScore")),this.score>this.highScore?(localStorage.setItem("LollyMatchHighScore",this.score),this.highScore=this.score):this.highScore=parseInt(localStorage.getItem("LollyMatchHighScore")));var t="HIGHSCORE: "+this.highScore;console.log("%c"+t,"color: blue; font-weight: bold")},createOverScreen:function(){var t=this.createBack();if(this.score<this.highScore){this.add.text(t.x+t.width/2,t.y+.18*t.height,this.ml.get("High Score"),LollyMatch.style2.a).anchor.set(.5);this.add.text(t.x+t.width/2,t.y+.28*t.height,this.highScore,LollyMatch.style2.a).anchor.set(.5);this.add.text(t.x+t.width/2,t.y+.42*t.height,this.ml.get("Your Score"),LollyMatch.style2.b).anchor.set(.5);this.add.text(t.x+t.width/2,t.y+.52*t.height,this.score,LollyMatch.style2.b).anchor.set(.5)}else{this.add.text(t.x+t.width/2,t.y+.18*t.height,this.ml.get("Congratulation"),LollyMatch.style2.a).anchor.set(.5);var i=this.add.sprite(t.x+t.width/2.5,t.y+.32*t.height,"uiSmall",0);i.scale.setTo(LollyMatch.scaleFactor),i.anchor.setTo(.5);this.add.text(i.x+1.6*i.width,i.y,this.ml.get("New"),LollyMatch.style2.a).anchor.set(.5);this.add.text(t.x+t.width/2,t.y+.45*t.height,this.ml.get("High Score"),LollyMatch.style2.a).anchor.set(.5);this.add.text(t.x+t.width/2,t.y+.58*t.height,this.highScore,LollyMatch.style2.a).anchor.set(.5)}var e=this.add.sprite(t.x+.3*t.width,t.y+.8*t.height,"uiBig",1);e.width=.3*t.width,e.height=e.width,e.anchor.setTo(.5),e.inputEnabled=!0,e.events.onInputDown.add(this.reloadState,this);var s=this.add.sprite(t.x+.7*t.width,t.y+.8*t.height,"uiBig",2);s.width=.3*t.width,s.height=s.width,s.anchor.setTo(.5),s.inputEnabled=!0,s.events.onInputDown.add(this.menuSate,this)},shutDown:function(){this.i=0,this.j=0,this.counter=0,this.gameOver=!1},reloadState:function(){this.shutDown(),this.state.start("False")},menuSate:function(){this.shutDown(),this.state.start("StartMenu")}};